<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>USGS Earthquakes in the Last Week</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html,
    body {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #container {
      display: flex;
      height: 100%;
    }

    #content {
      width: 60%;
      position: relative;
    }

    #infographics {
      width: 40%;
      height: 100%;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 0px;
    }

    #viewDiv {
      height: 100%;
      width: 100%;
    }

    #legendDiv {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: #FDF5C7;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      font-family: "Avenir Next W00", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    #legendDiv h3,
    #legendDiv h4 {
      margin: 5px 0;
    }

    #legendDiv div {
      display: flex;
      align-items: center;
      margin: 3px 0;
    }

    #legendDiv span {
      display: inline-block;
      margin-right: 8px;
    }

    .tectonic-line {
      width: 12px;
      height: 0;
      border-top: 2px solid red;
    }

    .sliderContainer {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      background-color: #FDF5C7;
      padding: 20px 37px 37px 37px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      width: 80%;
      box-sizing: border-box;
    }

    #dateSliderContainer {
      bottom: 150px;
    }

    #magnitudeSliderContainer {
      bottom: 60px;
    }

    .esri-widget {
      font-family: "Avenir Next W00", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    .esri-slider__ticks {
      bottom: -20px;
    }

    .esri-slider__tick-label {
      white-space: nowrap;
    }

    /* Custom slider styles */
    .esri-slider__thumb {
      background-color: #D9CC82 !important;
      border: 2px solid #655411 !important;
    }

    .esri-slider__track {
      background-color: #A8A69D !important;
    }

    .esri-zoom .esri-widget--button,
    .esri-navigation-toggle .esri-widget--button {
      background-color: #FDF5C7 !important;
      color: black !important;
    }

    .esri-zoom .esri-widget--button:hover,
    .esri-navigation-toggle .esri-widget--button:hover {
      background-color: #D9CC82 !important;
    }

    #countBox {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background-color: #FDF5C7;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      font-family: "Avenir Next W00", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    .sliderTitle {
      text-align: center;
      margin-bottom: 2px;
      font-size: 14px;
      font-weight: bold;
    }

    /* Custom popup styles */
    .esri-popup__main-container {
      background-color: #FDF5C7 !important;
    }

    /* Toggle button styles */
    #toggleButton {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: #FDF5C7;
      border: 1px solid #655411;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      font-family: "Avenir Next W00", "Helvetica Neue", Helvetica, Arial, sans-serif;
      z-index: 1000;
    }

    /* Infographics container */
    #chartContainer {
      width: 90%;
      margin: auto;
    }

    #infoList,
    #magnitudeList {
      width: 90%;
      margin: 20px auto;
      background-color: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      font-family: "Avenir Next W00", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    #infoList ul,
    #magnitudeList ul {
      padding: 0;
      list-style: none;
    }

    #infoList ul li,
    #magnitudeList ul li {
      margin-bottom: 5px;
    }

    @media (max-width: 767px) {
      #container {
        flex-direction: column;
      }

      #content,
      #infographics {
        width: 100%;
        height: 50%;
      }

      #dateSliderContainer,
      #magnitudeSliderContainer {
        padding: 10px 20px;
        width: 90%;
      }

      #dateSliderContainer {
        bottom: 120px;
      }

      #magnitudeSliderContainer {
        bottom: 30px;
      }

      .esri-slider__tick-label {
        display: none;
      }

      .sliderContainer {
        padding: 10px;
        width: 95%;
      }
    }
  </style>
  <script src="https://js.arcgis.com/4.25/"></script>
</head>

<body>
  <div id="container">
    <div id="content">
      <div id="viewDiv"></div>
      <div id="legendDiv"></div>
      <div id="toggleButton" onclick="toggleLegend()">Show Legend</div>
      <div id="dateSliderContainer" class="sliderContainer">
        <div id="dateSliderTitle" class="sliderTitle">Filter by Date Range</div>
        <div id="dateSliderDiv"></div>
      </div>
      <div id="magnitudeSliderContainer" class="sliderContainer">
        <div id="magnitudeSliderTitle" class="sliderTitle">Filter by Magnitude Range</div>
        <div id="magnitudeSliderDiv"></div>
      </div>
      <div id="countBox">Total Points: 0</div>
    </div>
    <div id="infographics">
      <div id="magnitudeList"></div>
      <div id="infoList"></div>
      <div id="chartContainer">
        <canvas id="earthquakeChart"></canvas>
      </div>
    </div>
  </div>
  <script>
    let earthquakeData = [];
    let earthquakeCountPerCountry = {};
    let earthquakeChart;
    let dateSlider;
    let magnitudeSlider;

    function toggleLegend() {
      var legendDiv = document.getElementById('legendDiv');
      var toggleButton = document.getElementById('toggleButton');
      if (legendDiv.style.display === 'none') {
        legendDiv.style.display = 'block';
        toggleButton.innerText = 'Hide Legend';
      } else {
        legendDiv.style.display = 'none';
        toggleButton.innerText = 'Show Legend';
      }
    }

    function minimizeLegendOnMobile() {
      if (window.innerWidth < 768) {
        document.getElementById('legendDiv').style.display = 'none';
        document.getElementById('toggleButton').innerText = 'Show Legend';
      }
    }

    window.onload = () => {
      minimizeLegendOnMobile();
      adjustSliderLabels();
    };
    window.onresize = () => {
      minimizeLegendOnMobile();
      adjustSliderLabels();
    };

    function adjustSliderLabels() {
      const isMobile = window.innerWidth < 768;
      if (isMobile) {
        dateSlider.tickConfigs = [{
          mode: "position",
          values: [dateSlider.min, dateSlider.min + (dateSlider.max - dateSlider.min) / 3, dateSlider.max],
          labelsVisible: true,
          labels: function (value) {
            return new Date(value).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
          }
        }];
        magnitudeSlider.tickConfigs = [{
          mode: "position",
          values: [1, 2.5, 5, 7.5, 10],
          labelsVisible: true,
          labels: function (value) {
            return value.toFixed(1);
          }
        }];
      } else {
        dateSlider.tickConfigs = [{
          mode: "position",
          values: Array.from({ length: 8 }, (_, i) => dateSlider.min + i * (1000 * 60 * 60 * 24)),
          labelsVisible: true,
          labels: function (value) {
            return new Date(value).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
          }
        }, {
          mode: "position",
          values: Array.from({ length: 8 * 4 }, (_, i) => dateSlider.min + (i * (1000 * 60 * 60 * 6))),
          labelsVisible: false
        }];
        magnitudeSlider.tickConfigs = [{
          mode: "position",
          values: [1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10],
          labelsVisible: true,
          labels: function (value) {
            return value.toFixed(1);
          }
        }, {
          mode: "position",
          values: Array.from({ length: 90 }, (_, i) => 1 + i * 0.1),
          labelsVisible: false
        }];
      }
      dateSlider.redraw();
      magnitudeSlider.redraw();
    }

    require([
      "esri/Map",
      "esri/views/SceneView",
      "esri/Graphic",
      "esri/layers/GraphicsLayer",
      "esri/layers/FeatureLayer",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/symbols/SimpleLineSymbol",
      "esri/renderers/SimpleRenderer",
      "esri/renderers/UniqueValueRenderer",
      "esri/request",
      "esri/geometry/geometryEngine",
      "esri/geometry/Point",
      "esri/geometry/projection",
      "esri/geometry/SpatialReference",
      "esri/widgets/Slider",
      "esri/widgets/Zoom",
      "esri/widgets/NavigationToggle",
      "esri/widgets/Popup"
    ], function (Map, SceneView, Graphic, GraphicsLayer, FeatureLayer, SimpleMarkerSymbol, SimpleLineSymbol, SimpleRenderer, UniqueValueRenderer, esriRequest, geometryEngine, Point, projection, SpatialReference, Slider, Zoom, NavigationToggle, Popup) {

      projection.load().then(function () {
        var map = new Map({
          basemap: "hybrid",
          ground: null
        });

        var view = new SceneView({
          container: "viewDiv",
          map: map,
          camera: {
            position: {
              x: -100,
              y: 40,
              z: 12000000
            },
            tilt: 0
          },
          environment: {
            lighting: {
              directShadowEnabled: false,
              ambientOcclusionEnabled: false,
            }
          },
          popup: new Popup({
            dockEnabled: false,
            dockOptions: {
              buttonEnabled: true,
              breakpoint: false,
              position: "top-right"
            }
          })
        });

        var tectonicPlatesLayer = new FeatureLayer({
          url: "https://services.arcgis.com/jIL9msH9OI208GCb/arcgis/rest/services/Tectonic_Plates_and_Boundaries/FeatureServer",
          renderer: new SimpleRenderer({
            symbol: new SimpleLineSymbol({
              color: "red",
              width: 2
            })
          })
        });
        map.add(tectonicPlatesLayer);

        var worldCountriesLayer = new FeatureLayer({
          url: "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Countries_(Generalized)/FeatureServer",
          outFields: ["COUNTRY"]
        });
        map.add(worldCountriesLayer);
        worldCountriesLayer.visible = false; // Hide the layer

        var graphicsLayer = new GraphicsLayer();
        map.add(graphicsLayer);

        var renderer = new UniqueValueRenderer({
          field: "mag",
          uniqueValueInfos: [
            {
              value: "<3",
              symbol: new SimpleMarkerSymbol({
                color: "yellow",
                size: 5,
                outline: {
                  color: "black",
                  width: 1
                }
              }),
              label: "< 3"
            },
            {
              value: "3-5.5",
              symbol: new SimpleMarkerSymbol({
                color: "orange",
                size: 5,
                outline: {
                  color: "black",
                  width: 1
                }
              }),
              label: "3 - 5.5"
            },
            {
              value: ">5.5",
              symbol: new SimpleMarkerSymbol({
                color: "red",
                size: 5,
                outline: {
                  color: "black",
                  width: 1
                }
              }),
              label: "> 5.5"
            }
          ]
        });

        graphicsLayer.renderer = renderer;

        function getSymbol(magnitude) {
          if (magnitude < 3) {
            return renderer.uniqueValueInfos[0].symbol;
          } else if (magnitude <= 5.5) {
            return renderer.uniqueValueInfos[1].symbol;
          } else {
            return renderer.uniqueValueInfos[2].symbol;
          }
        }

        function fetchEarthquakeData(startDate, endDate) {
          esriRequest("https://earthquake.usgs.gov/fdsnws/event/1/query", {
            query: {
              format: "geojson",
              starttime: startDate.toISOString(),
              endtime: endDate.toISOString()
            },
            responseType: "json"
          }).then(function (response) {
            console.log("Earthquake data fetched successfully.");
            earthquakeData = response.data.features.filter(function (feature) {
              return feature.properties.mag >= 1;
            });
            console.log("Filtered earthquake data:", earthquakeData);
            assignCountryToEarthquakes(startDate, endDate, magnitudeSlider.values[0], magnitudeSlider.values[1]);
          }).catch(function (error) {
            console.error("Error fetching earthquake data: ", error);
          });
        }

        function assignCountryToEarthquakes(startDate, endDate, minMagnitude, maxMagnitude) {
          var query = worldCountriesLayer.createQuery();
          query.returnGeometry = true;
          query.outFields = ["COUNTRY"];

          worldCountriesLayer.queryFeatures(query).then(function (result) {
            console.log("Country data fetched successfully.");
            var countryGeometries = result.features.map(function (feature) {
              return {
                geometry: feature.geometry,
                country: feature.attributes.COUNTRY
              };
            });

            console.log("Country geometries:", countryGeometries);

            earthquakeData.forEach(function (earthquake) {
              var point = new Point({
                longitude: earthquake.geometry.coordinates[0],
                latitude: earthquake.geometry.coordinates[1],
                spatialReference: SpatialReference.WGS84
              });

              var reprojectedPoint = projection.project(point, worldCountriesLayer.spatialReference);
              console.log("Reprojected point:", reprojectedPoint);

              var matchingCountry = countryGeometries.find(function (country) {
                return geometryEngine.contains(country.geometry, reprojectedPoint);
              });

              if (matchingCountry) {
                earthquake.properties.country = matchingCountry.country;
              } else {
                earthquake.properties.country = null; // Assign null to earthquakes outside country boundaries
              }
            });

            updateEarthquakeData(startDate, endDate, minMagnitude, maxMagnitude);
          }).catch(function (error) {
            console.error("Error querying country features: ", error);
          });
        }

        function updateEarthquakeData(startDate, endDate, minMagnitude, maxMagnitude) {
          graphicsLayer.removeAll();
          earthquakeCountPerCountry = {}; // Reset the count

          var filteredData = earthquakeData.filter(function (feature) {
            var featureDate = new Date(feature.properties.time);
            var isWithinDateRange = featureDate >= startDate && featureDate <= endDate;
            var isWithinMagnitudeRange = feature.properties.mag >= minMagnitude && feature.properties.mag <= maxMagnitude;
            return isWithinDateRange && isWithinMagnitudeRange;
          });

          filteredData.forEach(function (feature) {
            var geometry = {
              type: "point",
              longitude: feature.geometry.coordinates[0],
              latitude: feature.geometry.coordinates[1]
            };

            var attributes = feature.properties;

            var symbol = getSymbol(attributes.mag);

            var graphic = new Graphic({
              geometry: geometry,
              symbol: symbol,
              attributes: attributes,
              popupTemplate: {
                title: "Earthquake Info",
                content: [{
                  type: "fields",
                  fieldInfos: [{
                    fieldName: "mag",
                    label: "Magnitude"
                  },
                  {
                    fieldName: "place",
                    label: "Location"
                  },
                  {
                    fieldName: "time",
                    label: "Time",
                    format: {
                      dateFormat: "short-date-short-time"
                    }
                  }
                  ]
                }]
              }
            });

            graphicsLayer.add(graphic);

            // Count earthquakes per country
            if (attributes.country) {
              if (earthquakeCountPerCountry[attributes.country]) {
                earthquakeCountPerCountry[attributes.country]++;
              } else {
                earthquakeCountPerCountry[attributes.country] = 1;
              }
            }
          });

          document.getElementById("countBox").innerText = `Total Points: ${filteredData.length}`;
          displayEarthquakeChart(earthquakeCountPerCountry);
        }

        var legendDiv = document.getElementById('legendDiv');
        legendDiv.innerHTML = `
          <h3>Legend</h3>
          <h4>Earthquake Magnitude</h4>
          <div><span style="background-color: yellow; width: 12px; height: 12px; display: inline-block;"></span> < 3</div>
          <div><span style="background-color: orange; width: 12px; height: 12px; display: inline-block;"></span> 3 - 5.5</div>
          <div><span style="background-color: red; width: 12px; height: 12px; display: inline-block;"></span> > 5.5</div>
          <h4>Tectonic Plate Boundaries</h4>
          <div><span class="tectonic-line"></span> Tectonic Plates</div>
        `;

        var dateSliderDiv = document.getElementById('dateSliderDiv');
        dateSlider = new Slider({
          container: dateSliderDiv,
          min: new Date().setHours(0, 0, 0, 0),
          max: new Date().setHours(24, 0, 0, 0),
          values: [new Date().setHours(0, 0, 0, 0), new Date().getTime()],
          rangeLabelsVisible: true,
          labelInputsEnabled: true,
          labelFormatFunction: function (value) {
            return new Date(value).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
          }
        });

        dateSlider.on(["thumb-drag", "thumb-change"], function (event) {
          var newStartDate = new Date(dateSlider.values[0]);
          var newEndDate = new Date(dateSlider.values[1]);
          updateEarthquakeData(newStartDate, newEndDate, magnitudeSlider.values[0], magnitudeSlider.values[1]);
        });

        var magnitudeSliderDiv = document.getElementById('magnitudeSliderDiv');
        magnitudeSlider = new Slider({
          container: magnitudeSliderDiv,
          min: 1,
          max: 10,
          values: [1, 10],
          rangeLabelsVisible: true,
          labelInputsEnabled: true,
          labelFormatFunction: function (value) {
            return value.toFixed(1);
          },
          tickConfigs: [{
            mode: "position",
            values: [1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10],
            labelsVisible: true,
            labels: function (value) {
              return value.toFixed(1);
            }
          }, {
            mode: "position",
            values: Array.from({
              length: 90
            }, (_, i) => 1 + i * 0.1),
            labelsVisible: false
          }]
        });

        magnitudeSlider.on(["thumb-drag", "thumb-change"], function (event) {
          var newStartDate = new Date(dateSlider.values[0]);
          var newEndDate = new Date(dateSlider.values[1]);
          updateEarthquakeData(newStartDate, newEndDate, magnitudeSlider.values[0], magnitudeSlider.values[1]);
        });

        var endDate = new Date();
        var startDate = new Date();
        startDate.setDate(endDate.getDate() - 7);
        fetchEarthquakeData(startDate, endDate);

        var tomorrow = new Date(endDate.getTime() + (24 * 60 * 60 * 1000)).setHours(0, 0, 0, 0);
        dateSlider.min = startDate.setHours(0, 0, 0, 0);
        dateSlider.max = tomorrow;
        dateSlider.values = [startDate.getTime(), endDate.getTime()];
        dateSlider.tickConfigs = [{
          mode: "position",
          values: Array.from({
            length: 8
          }, (_, i) => startDate.getTime() + i * (1000 * 60 * 60 * 24)).concat(tomorrow),
          labelsVisible: true,
          labels: function (value) {
            return new Date(value).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
          }
        }, {
          mode: "position",
          values: Array.from({
            length: 8 * 4
          }, (_, i) => startDate.getTime() + (i * (1000 * 60 * 60 * 6))),
          labelsVisible: false
        }];

        // Remove the default compass widget
        view.ui.remove("compass");

        // Initialize the chart
        const ctx = document.getElementById('earthquakeChart').getContext('2d');
        earthquakeChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: [],
            datasets: [{
              label: 'Number of Earthquakes',
              data: [],
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      });

      function displayEarthquakeChart(data) {
        const sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, 10);
        const labels = sortedData.map(item => item[0]);
        const values = sortedData.map(item => item[1]);

        const infoList = document.getElementById('infoList');
        infoList.innerHTML = '<h3>Top 10 Countries by Earthquake Count</h3><ul>' +
          sortedData.map(item => `<li>${item[0]}: ${item[1]} earthquakes</li>`).join('') +
          '</ul>';

        const sortedMagnitudes = earthquakeData.sort((a, b) => b.properties.mag - a.properties.mag).slice(0, 10);
        const magnitudeList = document.getElementById('magnitudeList');
        magnitudeList.innerHTML = '<h3>Top 10 Highest Magnitude Earthquakes</h3><ul>' +
          sortedMagnitudes.map(item => `<li>${item.properties.place}: Magnitude ${item.properties.mag}</li>`).join('') +
          '</ul>';

        earthquakeChart.data.labels = labels;
        earthquakeChart.data.datasets[0].data = values;
        earthquakeChart.update();
      }
    });
  </script>
</body>

</html>
