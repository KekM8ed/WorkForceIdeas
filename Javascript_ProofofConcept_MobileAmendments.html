<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Workforce Proof of Concept - MapView with Bar Chart</title>
  <style>
    /* Styles to ensure the HTML and body take up the full viewport */
    html, body {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column; /* Changed for mobile */
    }

    /* Styles for the map view container */
    #viewDiv {
      position: relative; /* Changed for mobile */
      height: 60%; /* Adjust height for mobile */
      width: 100%;
      flex: 1; /* Allow map to take available space */
    }

    /* Styles for the statistics panel */
    #panel {
      position: relative; /* Changed for mobile */
      height: 40%; /* Adjust height for mobile */
      width: 100%;
      overflow-y: auto;
      padding: 10px; /* Adjusted padding for mobile */
      box-sizing: border-box;
      background-color: #fff; /* Ensure readability */
    }

    /* Styles for the filter container */
    #filterDiv {
      background-color: #2b2b2b;
      padding: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
      color: white;
      font-family: "Noto Sans", sans-serif;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      width: 300px;
    }

    /* Media query for larger screens */
    @media (min-width: 600px) {
      html, body {
        flex-direction: row;
      }

      #viewDiv {
        position: relative;
        height: 100%;
        width: 60%; /* Adjust width for larger screens */
      }

      #panel {
        position: relative;
        height: 100%;
        width: 40%; /* Adjust width for larger screens */
        padding: 20px;
      }
    }

    /* Media query for mobile landscape orientation */
    @media (orientation: landscape) and (max-width: 599px) {
      .esri-expand--left {
        left: 0 !important;
      }
    }

    /* Styles for filter labels */
    #filterDiv label {
      margin-right: 10px;
    }

    /* Styles for filter groups */
    .filter-group {
      margin: 0 10px;
    }
    .filter-group label {
      display: block;
      white-space: normal;
      max-width: 180px;
    }
    .filter-group input {
      margin-right: 5px;
    }

    /* Styles for details summary elements */
    details summary {
      cursor: pointer;
    }

    /* Styles for details summary marker */
    details summary::marker {
      color: white;
    }

    /* Styles for scrollable lists */
    .scrollable-list {
      max-height: 120px;
      overflow-y: auto;
      padding-right: 5px;
    }
    .scrollable-list div {
      padding: 2px 0;
      display: flex;
      align-items: center;
    }

    /* Styles for map canvas */
    #viewDiv canvas {
      width: 100% !important;
      height: auto !important;
    }

    /* Styles for chart canvas */
    #panel canvas {
      width: 100% !important; /* Adjust width to 100% */
      height: auto !important;
      margin: 0 auto; /* Center align the chart */
    }
  </style>
  <!-- ArcGIS API for JavaScript styles -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/dark/main.css" />
  <!-- Load the Chart.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
  <!-- Load the ArcGIS API for JavaScript -->
  <script src="https://js.arcgis.com/4.29/"></script>
</head>
<body>
  <div id="viewDiv"></div>
  <div id="panel"></div>
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/renderers/HeatmapRenderer",
      "esri/core/reactiveUtils",
      "esri/widgets/Legend",
      "esri/widgets/Expand",
      "esri/widgets/LayerList"
    ], (Map, MapView, FeatureLayer, HeatmapRenderer, reactiveUtils, Legend, Expand, LayerList) => {

      // Variables for charts
      let fuelChart, countryChart, powerplantChart;

      // Debounce function to delay the execution of a function
      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), wait);
        };
      }

      // Cluster labeling threshold and colors
      const clusterLabelThreshold = 1500;
      const haloColor = "#373837";
      const color = "#f0f0f0";

      // Cluster configuration
      const clusterConfig = {
        type: "cluster",
        popupTemplate: {
          title: "Cluster summary",
          content: [
            {
              type: "text",
              text: `
                This cluster represents <b>{cluster_count}</b> power plants with an average capacity of <b>{cluster_avg_capacity_mw} megawatts</b>.
                The power plants in this cluster produce a total of <b>{expression/total-mw} megawatts</b> of power.`
            },
            {
              type: "text",
              text: "Most power plants in this cluster generate power from <b>{cluster_type_fuel1}</b>."
            }
          ],
          fieldInfos: [
            { fieldName: "cluster_count", format: { places: 0, digitSeparator: true } },
            { fieldName: "cluster_avg_capacity_mw", format: { places: 2, digitSeparator: true } },
            { fieldName: "expression/total-mw", format: { places: 0, digitSeparator: true } }
          ],
          expressionInfos: [{
            name: "total-mw",
            title: "total megawatts",
            expression: "$feature.cluster_avg_capacity_mw * $feature.cluster_count"
          }]
        },
        clusterRadius: "120px",
        labelsVisible: true,
        labelingInfo: [{
          symbol: {
            type: "text",
            haloColor,
            haloSize: "1px",
            color,
            font: {
              family: "Noto Sans",
              size: "11px"
            },
            xoffset: 0,
            yoffset: "-15px"
          },
          labelPlacement: "center-center",
          labelExpressionInfo: {
            expression: "Text($feature.cluster_count, '#,### plants')"
          },
          where: `cluster_avg_capacity_mw > ${clusterLabelThreshold}`
        }, {
          symbol: {
            type: "text",
            haloColor,
            haloSize: "2px",
            color,
            font: {
              weight: "bold",
              family: "Noto Sans",
              size: "18px"
            },
            xoffset: 0,
            yoffset: 0
          },
          labelPlacement: "center-center",
          labelExpressionInfo: {
            expression: "$feature.cluster_type_fuel1"
          },
          where: `cluster_avg_capacity_mw > ${clusterLabelThreshold}`
        }, {
          symbol: {
            type: "text",
            haloColor,
            haloSize: "1px",
            color,
            font: {
              weight: "bold",
              family: "Noto Sans",
              size: "12px"
            },
            xoffset: 0,
            yoffset: "15px"
          },
          labelPlacement: "center-center",
          labelExpressionInfo: {
            expression: `
              var value = $feature.cluster_avg_capacity_mw;
              var num = Count(Text(Round(value)));
              Decode(num,
                4, Text(value / Pow(10, 3), "##.0k"),
                5, Text(value / Pow(10, 3), "##k"),
                6, Text(value / Pow(10, 3), "##k"),
                7, Text(value / Pow(10, 6), "##.0m"),
                Text(value, "#,###")
              );`
          },
          where: `cluster_avg_capacity_mw > ${clusterLabelThreshold}`
        }, {
          symbol: {
            type: "text",
            haloColor,
            haloSize: "1px",
            color,
            font: {
              family: "Noto Sans",
              size: "11px"
            },
            xoffset: 0,
            yoffset: "-15px"
          },
          labelPlacement: "above-right",
          labelExpressionInfo: {
            expression: "Text($feature.cluster_count, '#,### plants')"
          },
          where: `cluster_avg_capacity_mw <= ${clusterLabelThreshold}`
        }, {
          symbol: {
            type: "text",
            haloColor,
            haloSize: "2px",
            color,
            font: {
              weight: "bold",
              family: "Noto Sans",
              size: "18px"
            }
          },
          labelPlacement: "above-right",
          labelExpressionInfo: {
            expression: "$feature.cluster_type_fuel1"
          },
          where: `cluster_avg_capacity_mw <= ${clusterLabelThreshold}`
        }, {
          symbol: {
            type: "text",
            haloColor,
            haloSize: "1px",
            color,
            font: {
              weight: "bold",
              family: "Noto Sans",
              size: "12px"
            },
            xoffset: 0,
            yoffset: 0
          },
          labelPlacement: "center-center",
          labelExpressionInfo: {
            expression: `
              var value = $feature.cluster_avg_capacity_mw;
              var num = Count(Text(Round(value)));
              Decode(num,
                4, Text(value / Pow(10, 3), "##.0k"),
                5, Text(value / Pow(10, 3), "##k"),
                6, Text(value / Pow(10, 3), "##k"),
                7, Text(value / Pow(10, 6), "##.0m"),
                Text(value, "#,###")
              );`
          },
          where: `capacity_mw <= ${clusterLabelThreshold}`
        }]
      };

      // Heatmap renderer configuration
      const heatmapRenderer = new HeatmapRenderer({
        colorStops: [
          { ratio: 0, color: "rgba(255, 255, 255, 0)" },
          { ratio: 0.3, color: "rgba(51, 255, 243, 0.4)" },
          { ratio: 0.5, color: "rgba(255, 182, 193, 0.4)" },
          { ratio: 0.7, color: "rgba(255, 160, 122, 0.4)" },
          { ratio: 0.9, color: "rgba(250, 235, 215, 0.4)" }
        ],
        maxPixelIntensity: 50,
        minPixelIntensity: 0,
        legendOptions: {
          title: "Global Power Plant Heatmap"
        }
      });

      // Feature layer configuration for clustering
      const clusterLayer = new FeatureLayer({
        portalItem: {
          id: "eb54b44c65b846cca12914b87b315169"
        },
        featureReduction: clusterConfig,
        popupEnabled: true,
        title: "Global Power Plant Points",
        labelingInfo: [{
          symbol: {
            type: "text",
            haloColor,
            haloSize: "1px",
            color,
            font: { family: "Noto Sans", size: "11px" },
            xoffset: 0,
            yoffset: "-15px"
          },
          labelPlacement: "center-center",
          labelExpressionInfo: { expression: "$feature.name" },
          where: `capacity_mw > ${clusterLabelThreshold}`
        }, {
          symbol: {
            type: "text",
            haloColor,
            haloSize: "2px",
            color,
            font: { weight: "bold", family: "Noto Sans", size: "18px" },
            xoffset: 0,
            yoffset: 0
          },
          labelPlacement: "center-center",
          labelExpressionInfo: { expression: "$feature.fuel1" },
          where: `capacity_mw > ${clusterLabelThreshold}`
        }, {
          symbol: {
            type: "text",
            haloColor,
            haloSize: "1px",
            color,
            font: { weight: "bold", family: "Noto Sans", size: "12px" },
            xoffset: 0,
            yoffset: "15px"
          },
          labelPlacement: "center-center",
          labelExpressionInfo: {
            expression: `
              var value = $feature.capacity_mw;
              var num = Count(Text(Round(value)));
              Decode(num,
                4, Text(value / Pow(10, 3), "##.0k"),
                5, Text(value / Pow(10, 3), "##k"),
                6, Text(value / Pow(10, 3), "##k"),
                7, Text(value / Pow(10, 6), "##.0m"),
                Text(value, "#,###")
              );`
          },
          where: `capacity_mw > ${clusterLabelThreshold}`
        }, {
          symbol: {
            type: "text",
            haloColor,
            haloSize: "1px",
            color,
            font: { family: "Noto Sans", size: "11px" },
            xoffset: 0,
            yoffset: "-15px"
          },
          labelPlacement: "above-right",
          labelExpressionInfo: { expression: "$feature.name" },
          where: `capacity_mw <= ${clusterLabelThreshold}`
        }, {
          symbol: {
            type: "text",
            haloColor,
            haloSize: "2px",
            color,
            font: { weight: "bold", family: "Noto Sans", size: "18px" }
          },
          labelPlacement: "above-right",
          labelExpressionInfo: { expression: "$feature.fuel1" },
          where: `capacity_mw <= ${clusterLabelThreshold}`
        }, {
          symbol: {
            type: "text",
            haloColor,
            haloSize: "1px",
            color,
            font: { weight: "bold", family: "Noto Sans", size: "12px" },
            xoffset: 0,
            yoffset: 0
          },
          labelPlacement: "center-center",
          labelExpressionInfo: {
            expression: `
              var value = $feature.capacity_mw;
              var num = Count(Text(Round(value)));
              Decode(num,
                4, Text(value / Pow(10, 3), "##.0k"),
                5, Text(value / Pow(10, 3), "##k"),
                6, Text(value / Pow(10, 3), "##k"),
                7, Text(value / Pow(10, 6), "##.0m"),
                Text(value, "#,###")
              );`
          },
          where: `capacity_mw <= ${clusterLabelThreshold}`
        }]
      });

      // Update renderer after layer is loaded
      clusterLayer.when(() => {
        const renderer = clusterLayer.renderer.clone();
        renderer.visualVariables = [{
          type: "size",
          field: "capacity_mw",
          legendOptions: {
            title: "Capacity (MW)"
          },
          minSize: "24px",
          maxSize: "100px",
          minDataValue: 1,
          maxDataValue: 5000
        }];
        clusterLayer.renderer = renderer;
      });

      // Feature layer configuration for heatmap
      const heatmapLayer = new FeatureLayer({
        portalItem: {
          id: "eb54b44c65b846cca12914b87b315169"
        },
        outFields: ["country_long", "capacity_mw", "fuel1"],
        renderer: heatmapRenderer,
        title: "Global Power Plant Heatmap",
      });

      // Map configuration
      const map = new Map({
        basemap: "streets-night-vector",
        layers: [heatmapLayer, clusterLayer]
      });

      // MapView configuration
      const view = new MapView({
        container: "viewDiv",
        map: map,
        zoom: 4.8,
        center: [0, 54]
      });

      // Watch for scale changes and update visibility
      view.when(async () => {
        // reactiveUtils.watch(
        //   () => view.scale,
        //   (scale) => {
        //     heatmapLayer.visible = scale > 60000;
        //     clusterLayer.featureReduction = scale > 60000 ? clusterConfig : null;
        //   }
        // );

        // Wait for layer view to be ready and query features
        const layerView = await view.whenLayerView(heatmapLayer);
        reactiveUtils.when(
          () => !layerView.updating,
          async () => {
            debouncedUpdateStats(layerView);
          }
        );

        // Debounce the updateStats function to wait for 0.4 seconds of stability
        const debouncedUpdateStats = debounce(updateStats, 400);

        // Watch for extent changes and update stats
        view.watch("extent", () => {
          debouncedUpdateStats(layerView);
        });
      });
      
      function areLayersVisible(layers) {
        return layers.some(layer => layer.visible);
        
      }

      // Function to update statistics based on current view extent
      function updateStats(layerView) {
        
        const layers = [clusterLayer, heatmapLayer];
  if (!areLayersVisible(layers)) {
    renderStats({}, false);
    return;
  }
        
        const query = layerView.createQuery();
        query.geometry = view.extent;
        layerView.queryFeatures(query).then(result => {
          const statsQuery = query.clone();
          statsQuery.outStatistics = createStatDefinitions();
          layerView.queryFeatures(statsQuery).then(response => {
            const stats = response.features[0].attributes;
            const hasData = result.features.length > 0;
            renderStats(stats, hasData);
          });
        });
      }

      // Function to create statistical definitions for queries
      function createStatDefinitions() {
        const statDefinitions = [];
        const fuels = ["Hydro", "Gas", "Other", "Oil", "Wind", "Nuclear", "Coal", "Solar", "Waste", "Biomass", "Geothermal"];
        const countries = ["Afghanistan", "Albania", "Algeria", "Angola", "Antarctica", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahrain", "Bangladesh", "Belarus", "Belgium", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei Darussalam", "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada", "Cape Verde", "Central African Republic", "Chile", "China", "Colombia", "Congo", "Costa Rica", "Cote DIvoire", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Democratic Republic of the Congo", "Denmark", "Djibouti", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Ethiopia", "Fiji", "Finland", "France", "French Guiana", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kosovo", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Lithuania", "Luxembourg", "Macedonia", "Madagascar", "Malawi", "Malaysia", "Mali", "Mauritania", "Mauritius", "Mexico", "Moldova", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "Norway", "Oman", "Pakistan", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saudi Arabia", "Senegal", "Serbia", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "South Africa", "South Korea", "Spain", "Sri Lanka", "Sudan", "Swaziland", "Sweden", "Switzerland", "Syrian Arab Republic", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States of America", "Uruguay", "Uzbekistan", "Venezuela", "Vietnam", "Western Sahara", "Yemen", "Zambia", "Zimbabwe"];

        fuels.forEach(fuel => {
          statDefinitions.push({
            onStatisticField: `CASE WHEN fuel1 = '${fuel}' THEN capacity_mw ELSE 0 END`,
            outStatisticFieldName: `Total_${fuel}MW`,
            statisticType: "sum"
          });
          statDefinitions.push({
            onStatisticField: `CASE WHEN fuel1 = '${fuel}' THEN 1 ELSE 0 END`,
            outStatisticFieldName: `Total_${fuel}`,
            statisticType: "sum"
          });
        });

        countries.forEach(country => {
          statDefinitions.push({
            onStatisticField: `CASE WHEN country_long = '${country}' THEN capacity_mw ELSE 0 END`,
            outStatisticFieldName: `Total_${country.replace(/ /g, '_')}`,
            statisticType: "sum"
          });
          statDefinitions.push({
            onStatisticField: `CASE WHEN country_long = '${country}' THEN 1 ELSE 0 END`,
            outStatisticFieldName: `Total_${country.replace(/ /g, '_')}_Count`,
            statisticType: "sum"
          });
        });

        return statDefinitions;
      }

      // Function to render statistics in the side panel and create charts
      function renderStats(stats, hasData) {
        console.log("Stats object:", stats);

        const panel = document.getElementById("panel");
        panel.innerHTML = `<h2>Summary Statistics</h2>`;
        
        if (!hasData) {
          panel.innerHTML += `<p>No data is being displayed.</p>`;
          return;
        }

        const fuels = ["Hydro", "Gas", "Other", "Oil", "Wind", "Nuclear", "Coal", "Solar", "Waste", "Biomass", "Geothermal"];
        const countries = ["Afghanistan", "Albania", "Algeria", "Angola", "Antarctica", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahrain", "Bangladesh", "Belarus", "Belgium", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei Darussalam", "Bulgaria", "Burkina Faso", "Burundi", "Cambodia", "Cameroon", "Canada", "Cape Verde", "Central African Republic", "Chile", "China", "Colombia", "Congo", "Costa Rica", "Cote DIvoire", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Democratic Republic of the Congo", "Denmark", "Djibouti", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Ethiopia", "Fiji", "Finland", "France", "French Guiana", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kosovo", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Lithuania", "Luxembourg", "Macedonia", "Madagascar", "Malawi", "Malaysia", "Mali", "Mauritania", "Mauritius", "Mexico", "Moldova", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "Norway", "Oman", "Pakistan", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saudi Arabia", "Senegal", "Serbia", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "South Africa", "South Korea", "Spain", "Sri Lanka", "Sudan", "Swaziland", "Sweden", "Switzerland", "Syrian Arab Republic", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States of America", "Uruguay", "Uzbekistan", "Venezuela", "Vietnam", "Western Sahara", "Yemen", "Zambia", "Zimbabwe"];

        const fuelStats = fuels.map(fuel => {
          const value = Math.round(stats[`Total_${fuel}MW`]);
          return { fuel, value };
        }).sort((a, b) => b.value - a.value).slice(0, 15);

        const countryStats = countries.map(country => {
          const value = Math.round(stats[`Total_${country.replace(/ /g, '_')}`]);
          return { country, value };
        }).sort((a, b) => b.value - a.value).slice(0, 15);

        const powerPlantStats = countries.map(country => {
          const value = Math.round(stats[`Total_${country.replace(/ /g, '_')}_Count`]);
          return { country, value };
        }).sort((a, b) => b.value - a.value).slice(0, 15);

        console.log("Fuel Stats:", fuelStats);
        console.log("Country Stats:", countryStats);
        console.log("Power Plant Stats:", powerPlantStats);

        const fuelStatsHtml = fuelStats.map(stat => `<p>${stat.fuel} Capacity: ${stat.value} MW</p>`).join("");
        const countryStatsHtml = countryStats.map(stat => `<p>${stat.country} Capacity: ${stat.value} MW</p>`).join("");
        const powerPlantStatsHtml = powerPlantStats.map(stat => `<p>${stat.country} Power Plants: ${stat.value}</p>`).join("");

        panel.innerHTML += `<h3>Fuel Types by Energy Generated</h3>${fuelStatsHtml}`;
        panel.innerHTML += `<canvas id="fuelChart"></canvas>`;
        panel.innerHTML += `<h3>Top 15 Countries by Energy Generation</h3>${countryStatsHtml}`;
        panel.innerHTML += `<canvas id="countryChart"></canvas>`;
        panel.innerHTML += `<h3>Top 15 Countries by Number of Power Plants</h3>${powerPlantStatsHtml}`;
        panel.innerHTML += `<canvas id="powerplantChart"></canvas>`;

        const fuelLabels = fuelStats.map(stat => stat.fuel);
        const fuelData = fuelStats.map(stat => stat.value);

        const countryLabels = countryStats.map(stat => stat.country);
        const countryData = countryStats.map(stat => stat.value);

        const powerPlantLabels = powerPlantStats.map(stat => stat.country);
        const powerPlantData = powerPlantStats.map(stat => stat.value);

        // Map of country name replacements
        const countryNameMap = {
          "Democratic Republic of the Congo": "DR Congo",
          // Add more mappings here if needed
        };

        // Apply the country name replacements
        const modifiedCountryLabels = countryLabels.map(country => countryNameMap[country] || country);
        const modifiedPowerPlantLabels = powerPlantLabels.map(country => countryNameMap[country] || country);

        const fuelColorMap = {
          "Hydro": '#a6cee3',
          "Gas": '#fb9a99',
          "Other": '#aaaaaa',
          "Oil": '#e31a1c',
          "Wind": '#33a02c',
          "Nuclear": '#6a3d9a',
          "Coal": '#fdbf6f',
          "Solar": '#b2df8a',
          "Waste": '#cab2d6',
          "Biomass": '#ff7f00',
          "Geothermal": '#1f78b4'
        };

        const fuelColors = fuelLabels.map(fuel => fuelColorMap[fuel]);

        console.log("Fuel Labels:", fuelLabels);
        console.log("Fuel Data:", fuelData);
        console.log("Fuel Colors:", fuelColors);

        if (fuelChart) {
          fuelChart.destroy();
        }

        if (countryChart) {
          countryChart.destroy();
        }

        if (powerplantChart) {
          powerplantChart.destroy();
        }

        // Helper function to initialize chart
        function initializeChart() {
          try {
            const fuelChartElement = document.getElementById('fuelChart');
            const countryChartElement = document.getElementById('countryChart');
            const powerplantChartElement = document.getElementById('powerplantChart');

            if (!fuelChartElement || !countryChartElement || !powerplantChartElement) {
              console.error('Canvas elements not found');
              setTimeout(initializeChart, 100); // Retry after 100ms if elements are not found
              return;
            }

            const fuelCtx = fuelChartElement.getContext('2d');
            const countryCtx = countryChartElement.getContext('2d');
            const powerplantCtx = powerplantChartElement.getContext('2d');

            if (!fuelCtx || !countryCtx || !powerplantCtx) {
              console.error('Failed to get 2D context for charts');
              setTimeout(initializeChart, 100); // Retry after 100ms if context is not available
              return;
            }

            fuelChart = new Chart(fuelCtx, {
              type: 'bar',
              data: {
                labels: fuelLabels,
                datasets: [
                  {
                    label: "Capacity (MW)",
                    data: fuelData,
                    backgroundColor: fuelColors
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false, /* Added to ensure the chart is responsive */
                title: {
                  display: true,
                  text: "MW Capacity by Fuel Type"
                },
                tooltips: {
                  callbacks: {
                    label: function(tooltipItem, data) {
                      const dataset = data.datasets[tooltipItem.datasetIndex];
                      const total = dataset.data.reduce((sum, value) => sum + value, 0);
                      const value = dataset.data[tooltipItem.index];
                      const percentage = ((value / total) * 100).toFixed(2);
                      return `${data.labels[tooltipItem.index]}: ${value} MW (${percentage}%)`;
                    }
                  }
                },
                scales: {
                  yAxes: [{
                    ticks: {
                      beginAtZero: true
                    },
                    scaleLabel: {
                      display: true,
                      labelString: 'Capacity (MW)'
                    }
                  }],
                  xAxes: [{
                    scaleLabel: {
                      display: true,
                      labelString: 'Fuel Type'
                    },
                    ticks: {
                      autoSkip: false // Ensure all labels are displayed
                    }
                  }]
                }
              }
            });

            countryChart = new Chart(countryCtx, {
              type: 'bar',
              data: {
                labels: modifiedCountryLabels,
                datasets: [
                  {
                    label: "Capacity (MW)",
                    data: countryData,
                    backgroundColor: '#36a2eb'
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false, /* Added to ensure the chart is responsive */
                title: {
                  display: true,
                  text: "Top 15 Countries by Energy Generation"
                },
                tooltips: {
                  callbacks: {
                    label: function(tooltipItem, data) {
                      const dataset = data.datasets[tooltipItem.datasetIndex];
                      const total = dataset.data.reduce((sum, value) => sum + value, 0);
                      const value = dataset.data[tooltipItem.index];
                      const percentage = ((value / total) * 100).toFixed(2);
                      return `${data.labels[tooltipItem.index]}: ${value} MW (${percentage}%)`;
                    }
                  }
                },
                scales: {
                  yAxes: [{
                    ticks: {
                      beginAtZero: true
                    },
                    scaleLabel: {
                      display: true,
                      labelString: 'Capacity (MW)'
                    }
                  }],
                  xAxes: [{
                    scaleLabel: {
                      display: true,
                      labelString: 'Country'
                    },
                    ticks: {
                      autoSkip: false // Ensure all labels are displayed
                    }
                  }]
                }
              }
            });

            powerplantChart = new Chart(powerplantCtx, {
              type: 'bar',
              data: {
                labels: modifiedPowerPlantLabels,
                datasets: [
                  {
                    label: "Number of Power Plants",
                    data: powerPlantData,
                    backgroundColor: '#4bc0c0'
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false, /* Added to ensure the chart is responsive */
                title: {
                  display: true,
                  text: "Top 15 Countries by Number of Power Plants"
                },
                tooltips: {
                  callbacks: {
                    label: function(tooltipItem, data) {
                      const dataset = data.datasets[tooltipItem.datasetIndex];
                      const total = dataset.data.reduce((sum, value) => sum + value, 0);
                      const value = dataset.data[tooltipItem.index];
                      const percentage = ((value / total) * 100).toFixed(2);
                      return `${data.labels[tooltipItem.index]}: ${value} (${percentage}%)`;
                    }
                  }
                },
                scales: {
                  yAxes: [{
                    ticks: {
                      beginAtZero: true
                    },
                    scaleLabel: {
                      display: true,
                      labelString: 'Number of Power Plants'
                    }
                  }],
                  xAxes: [{
                    scaleLabel: {
                      display: true,
                      labelString: 'Country'
                    },
                    ticks: {
                      autoSkip: false // Ensure all labels are displayed
                    }
                  }]
                }
              }
            });
          } catch (error) {
            console.error('Error initializing charts:', error);
          }
        }

        // Delay chart initialization to ensure canvas elements are rendered
        requestAnimationFrame(initializeChart);
      }

      // Add legend to the view
      const legend = new Legend({
        view: view
      });

      // Expand widget for the legend
      const legendExpand = new Expand({
        view: view,
        content: legend,
        expandIconClass: "esri-icon-legend",
        expanded: true
      });

      view.ui.add(legendExpand, "top-left");

      // Layer list widget
      const layerList = new LayerList({
        view: view,
      });

      // Expand widget for the layer list
      const layerListExpand = new Expand({
        view: view,
        content: layerList,
        expandIconClass: "esri-icon-layer-list",
        expanded: false
      });

      view.ui.add(layerListExpand, "top-left");

      // Filter container element
      const filterDiv = document.createElement("div");
      filterDiv.id = "filterDiv";
      filterDiv.innerHTML = `
        <details class="filter-group">
          <summary>Filter by Fuel Type</summary>
          <div>
            <label>
              <input type="checkbox" id="fuel-all" value="all">
              All
            </label>
          </div>
          <div id="fuelFilter" class="scrollable-list"></div>
        </details>
        <details class="filter-group">
          <summary>Filter by Country</summary>
          <div>
            <label>
              <input type="checkbox" id="country-all" value="all">
              All
            </label>
          </div>
          <div id="countryFilter" class="scrollable-list"></div>
        </details>
      `;

      const filterExpand = new Expand({
        view: view,
        content: filterDiv,
        expandIconClass: "esri-icon-filter",
        expanded: false
      });

      view.ui.add(filterExpand, "top-left");

      // Populate filters with distinct values from the layer
      clusterLayer.when(() => {
        const fuelQuery = clusterLayer.createQuery();
        fuelQuery.returnDistinctValues = true;
        fuelQuery.outFields = ["fuel1"];
        clusterLayer.queryFeatures(fuelQuery).then((result) => {
          const fuelSet = new Set();
          result.features.forEach((feature) => {
            fuelSet.add(feature.attributes.fuel1);
          });

          const fuelFilter = document.getElementById("fuelFilter");
          fuelSet.forEach((value) => {
            const div = document.createElement("div");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = value;
            checkbox.id = `fuel-${value}`;
            const label = document.createElement("label");
            label.htmlFor = `fuel-${value}`;
            label.textContent = value;
            div.appendChild(checkbox);
            div.appendChild(label);
            fuelFilter.appendChild(div);
          });

          if (!fuelSet.has("Geothermal")) {
            const geoDiv = document.createElement("div");
            const geoCheckbox = document.createElement("input");
            geoCheckbox.type = "checkbox";
            geoCheckbox.value = "Geothermal";
            geoCheckbox.id = "fuel-Geothermal";
            const geoLabel = document.createElement("label");
            geoLabel.htmlFor = "fuel-Geothermal";
            geoLabel.textContent = "Geothermal";
            geoDiv.appendChild(geoCheckbox);
            geoDiv.appendChild(geoLabel);
            fuelFilter.appendChild(geoDiv);
          }

          addFilterEventListeners();
        });

        const countryQuery = clusterLayer.createQuery();
        countryQuery.returnDistinctValues = true;
        countryQuery.outFields = ["country_long"];
        countryQuery.orderByFields = ["country_long"];
        countryQuery.returnGeometry = false;
        clusterLayer.queryFeatures(countryQuery).then((result) => {
          const countrySet = new Set();
          result.features.forEach((feature) => {
            countrySet.add(feature.attributes.country_long);
          });

          const countryFilter = document.getElementById("countryFilter");
          countrySet.forEach((value) => {
            const div = document.createElement("div");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = value;
            checkbox.id = `country-${value}`;
            const label = document.createElement("label");
            label.htmlFor = `country-${value}`;
            label.textContent = value;
            div.appendChild(checkbox);
            div.appendChild(label);
            countryFilter.appendChild(div);
          });

          addFilterEventListeners();
        });
      });

      function addFilterEventListeners() {
        document.getElementById("fuelFilter").addEventListener("change", updateFilter);
        document.getElementById("countryFilter").addEventListener("change", updateFilter);

        document.getElementById("fuel-all").addEventListener("change", (e) => toggleAll(e, "fuel"));
        document.getElementById("country-all").addEventListener("change", (e) => toggleAll(e, "country"));
      }

      // Function to update filters based on selected checkboxes
      function updateFilter() {
        const selectedFuels = Array.from(document.querySelectorAll("#fuelFilter input:checked")).map(input => input.value);
        const selectedCountries = Array.from(document.querySelectorAll("#countryFilter input:checked")).map(input => input.value);

        let fuelFilter = "";
        if (selectedFuels.length) {
          fuelFilter = `fuel1 IN ('${selectedFuels.join("','")}')`;
        }

        let countryFilter = "";
        if (selectedCountries.length) {
          countryFilter = `country_long IN ('${selectedCountries.join("','")}')`;
        }

        let filter = [fuelFilter, countryFilter].filter(Boolean).join(" AND ");
        clusterLayer.definitionExpression = filter;
        heatmapLayer.definitionExpression = filter;

        // Update the stats and charts
        view.whenLayerView(heatmapLayer).then(layerView => {
          debouncedUpdateStats(layerView);
        });
      }

      // Function to toggle all checkboxes in a filter group
      function toggleAll(event, type) {
        const checkboxes = document.querySelectorAll(`#${type}Filter input`);
        checkboxes.forEach(checkbox => checkbox.checked = event.target.checked);
        updateFilter();
      }
    });
  </script>
</body>
</html>
